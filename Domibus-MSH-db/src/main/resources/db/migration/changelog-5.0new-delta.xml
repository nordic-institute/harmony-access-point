<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <!-- properties - to be used in column definitions -->
    <include file="../common/changelog-properties.xml" relativeToChangelogFile="true"/>

    <!-- Start here 4.2 to new 5.0 -->

    <!-- Start Dictionary Tables -->
    <changeSet author="Cosmin Baciu" id="EDELIVERY-7803-Dictionary Tables">
        <createTable tableName="TB_D_MSH_ROLE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MSH_ROLE"/>
            </column>
            <column name="ROLE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="ROLE" constraintName="UK_D_MSH_ROLE" tableName="TB_D_MSH_ROLE"/>

        <createTable tableName="TB_D_MESSAGE_PROPERTY">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MSG_PROPERTY"/>
            </column>
            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="VALUE" type="VARCHAR(1024)"/>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="NAME" constraintName="UK_D_MSG_PROP_NAME" tableName="TB_D_MESSAGE_PROPERTY"/>

        <createTable tableName="TB_D_PART_PROPERTY">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_PART_PROPERTY"/>
            </column>
            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="VALUE" type="VARCHAR(1024)"/>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="NAME" constraintName="UK_D_PART_PROP_NAME" tableName="TB_D_PART_PROPERTY"/>

        <createTable tableName="TB_D_MPC">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MPC"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_MPC_VALUE" tableName="TB_D_MPC"/>

        <createTable tableName="TB_D_SERVICE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_SERVICE"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_SERVICE_VALUE" tableName="TB_D_SERVICE"/>

        <createTable tableName="TB_D_PARTY">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_PARTY"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_PARTY_VALUE" tableName="TB_D_PARTY"/>

        <createTable tableName="TB_D_ACTION">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_ACTION"/>
            </column>
            <column name="ACTION" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="ACTION" constraintName="UK_D_PARTY_ACTION" tableName="TB_D_ACTION"/>

        <createTable tableName="TB_D_AGREEMENT">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_AGREEMENT"/>
            </column>
            <column name="VALUE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(255)"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="VALUE" constraintName="UK_D_AGREEMENT_VALUE" tableName="TB_D_AGREEMENT"/>

        <createTable tableName="TB_D_ROLE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_ROLE"/>
            </column>
            <column name="ROLE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="ROLE" constraintName="UK_D_ROLE_VALUE" tableName="TB_D_ROLE"/>

        <createTable tableName="TB_D_NOTIFICATION_STATUS">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_NOTIFICATION_STATUS"/>
            </column>
            <column name="STATUS" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="STATUS" constraintName="UK_D_NOTIF_STATUS" tableName="TB_D_NOTIFICATION_STATUS"/>

        <createTable tableName="TB_D_MESSAGE_STATUS">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MESSAGE_STATUS"/>
            </column>
            <column name="STATUS" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="STATUS" constraintName="UK_D_MESSAGE_STATUS" tableName="TB_D_MESSAGE_STATUS"/>

        <createTable tableName="TB_D_MESSAGE_SUBTYPE">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_D_MESSAGE_SUBTYPE"/>
            </column>
            <column name="SUBTYPE" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addUniqueConstraint columnNames="SUBTYPE" constraintName="UK_D_MESSAGE_SUBTYPE" tableName="TB_D_MESSAGE_SUBTYPE"/>
    </changeSet>
    <!-- End Dictionary Tables -->

    <!-- Start new tables -->
    <changeSet  author="Catalin Enache"  id="EDELIVERY-7833-new-tables">
        <createTable tableName="TB_PART_PROPERTIES">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_PART_PROPERTIES"/>
            </column>
            <column name="PART_INFO_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="PART_INFO_PROPERTY_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="PART_INFO_ID_FK" baseTableName="TB_PART_PROPERTIES"
                                 constraintName="FK_PART_PROPS_PART_INFO" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_PART_INFO"/>
        <addForeignKeyConstraint baseColumnNames="PART_INFO_PROPERTY_FK" baseTableName="TB_PART_PROPERTIES"
                                 constraintName="FK_PART_PROPS_PART_PROP" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_D_PART_PROPERTY"/>
        <createIndex indexName="IDX_PART_PROPS_PART_INFO" tableName="TB_PART_PROPERTIES">
            <column name="PART_INFO_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_PART_PROPS_PART_PROP" tableName="TB_PART_PROPERTIES">
            <column name="PART_INFO_PROPERTY_FK"/>
        </createIndex>
        <addUniqueConstraint columnNames="PART_INFO_ID_FK,PART_INFO_PROPERTY_FK" constraintName="UK_PART_PROPS_FKS" tableName="TB_PART_PROPERTIES"/>
    </changeSet>
    <!-- End new tables -->

    <!-- Start Dropped tables -->
    <changeSet author="Catalin Enache" id="EDELIVERY-7833-drop-tables">
        <comment>drop tables</comment>

        <dropAllForeignKeyConstraints baseTableName="TB_RECEIPT_DATA"/> <!-- we need this ? -->
        <dropTable tableName="TB_RECEIPT_DATA"/>

        <dropForeignKeyConstraint baseTableName="TB_USER_MESSAGE" constraintName="FK_BE4XC1069QYW2KLHVM3XMG26S" />
        <dropForeignKeyConstraint baseTableName="TB_SIGNAL_MESSAGE" constraintName="FK_C08LJJWI4P9DX1RJTCDBE1SFU"/>
        <dropUniqueConstraint tableName="TB_MESSAGE_INFO" constraintName="UK_ECRRAOE83O1UQQ0DN9424X7LN"/> <!-- we need this ? -->
        <dropTable tableName="TB_MESSAGE_INFO"/>

        <dropAllForeignKeyConstraints baseTableName="TB_MESSAGING"/>
        <dropTable tableName="TB_MESSAGING"/>

        <dropAllForeignKeyConstraints baseTableName="TB_ERROR" /> <!-- we need this ? -->
        <dropTable tableName="TB_ERROR"/>
    </changeSet>
    <!-- End Dropped tables -->

    <!-- Start tables to be migrated -->
    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-sj-message">
        <!-- rename TB_MESSAGE_HEADER -->
        <renameTable oldTableName="TB_MESSAGE_HEADER" newTableName="TB_SJ_MESSAGE_HEADER" />

        <!-- start rename TB_MESSAGE_GROUP -->
        <dropAllForeignKeyConstraints baseTableName="TB_MESSAGE_GROUP" />
        <dropIndex tableName="TB_MESSAGE_GROUP" indexName="FK_MG_MH" />
        <renameTable oldTableName="TB_MESSAGE_GROUP" newTableName="TB_SJ_MESSAGE_GROUP" />
        <sql dbms="oracle">
            ALTER TABLE TB_SJ_MESSAGE_GROUP RENAME CONSTRAINT PK_TB_MESSAGE_GROUP TO PK_SJ_MESSAGE_GROUP;
        </sql>

        <addColumn tableName="TB_SJ_MESSAGE_GROUP">
            <column name="MSH_ROLE_ID_FK" remarks="The role of the MSH" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="SOURCE_MESSAGE_ID_FK" remarks="The SourceMessage id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <!-- TODO migration script here -->
        <dropColumn tableName="TB_SJ_MESSAGE_GROUP" columnName="MSH_ROLE" />
        <dropColumn tableName="TB_SJ_MESSAGE_GROUP" columnName="SOURCE_MESSAGE_ID" />
        <dropColumn tableName="TB_SJ_MESSAGE_GROUP" columnName="FK_MESSAGE_HEADER_ID" />

        <createIndex indexName="IDX_SJ_MG_SM_ID_FK" tableName="TB_SJ_MESSAGE_GROUP">
            <column name="SOURCE_MESSAGE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_SJ_MG_ROLE_FK" tableName="TB_SJ_MESSAGE_GROUP">
            <column name="MSH_ROLE_ID_FK"/>
        </createIndex>
        <!-- end rename TB_MESSAGE_GROUP -->

        <!-- start rename TB_MESSAGE_FRAGMENT -->
        <dropAllForeignKeyConstraints baseTableName="TB_MESSAGE_FRAGMENT" />
        <dropIndex tableName="TB_MESSAGE_FRAGMENT" indexName="IDX_MF_GRP_ID"/>
        <renameTable oldTableName="TB_MESSAGE_FRAGMENT" newTableName="TB_SJ_MESSAGE_FRAGMENT" />
        <sql dbms="oracle">
            ALTER TABLE TB_SJ_MESSAGE_FRAGMENT RENAME CONSTRAINT PK_TB_MESSAGE_FRAGMENT TO PK_MESSAGE_FRAGMENT;
        </sql>
        <addColumn tableName="TB_SJ_MESSAGE_FRAGMENT">
            <column name="GROUP_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addNotNullConstraint tableName="TB_SJ_MESSAGE_FRAGMENT" columnName="FRAGMENT_NUMBER" columnDataType="INT"/>
        <!-- TODO migration script here -->
        <dropColumn tableName="TB_SJ_MESSAGE_FRAGMENT" columnName="GROUP_ID"/>

        <createIndex indexName="IDX_FK_SJ_MSG_FG_GROUP" tableName="TB_SJ_MESSAGE_FRAGMENT">
            <column name="GROUP_ID_FK"/>
        </createIndex>
        <!-- add FKs at the end -->
        <addForeignKeyConstraint baseColumnNames="MSH_ROLE_ID_FK" baseTableName="TB_SJ_MESSAGE_GROUP"
                                 constraintName="FK_MSG_FG_GROUP_MSH_ROLE" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MSH_ROLE"/>
        <addForeignKeyConstraint baseColumnNames="SOURCE_MESSAGE_ID_FK" baseTableName="TB_SJ_MESSAGE_GROUP"
                                 constraintName="FK_MSG_FG_GROUP_UM" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_SJ_MESSAGE_GROUP"
                                 constraintName="FK_MSG_FG_GROUP_MH" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_SJ_MESSAGE_HEADER"/>
        <addForeignKeyConstraint baseColumnNames="GROUP_ID_FK" baseTableName="TB_SJ_MESSAGE_FRAGMENT"
                                 constraintName="FK_SJ_MSG_FG_GROUP" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_SJ_MESSAGE_GROUP"/>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_SJ_MESSAGE_FRAGMENT"
                                 constraintName="FK_SJ_MSG_FG_USER_MSG" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <!-- end rename TB_MESSAGE_FRAGMENT -->
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-message-log-migration">
        <!-- create TB_USER_MESSAGE_LOG -->
        <createTable tableName="TB_USER_MESSAGE_LOG">
            <column name="ID_PK" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_MESSAGE_LOG"/>
            </column>
            <column name="BACKEND" type="VARCHAR(255)"/>
            <column name="RECEIVED" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="DOWNLOADED" type="TIMESTAMP"/>
            <column name="FAILED" type="TIMESTAMP"/>
            <column name="RESTORED" type="TIMESTAMP"/>
            <column name="DELETED" type="TIMESTAMP"/>
            <column name="NEXT_ATTEMPT" type="TIMESTAMP"/>
            <column name="SEND_ATTEMPTS" type="INT"/>
            <column name="SEND_ATTEMPTS_MAX" type="INT"/>
            <column name="SCHEDULED" type="BOOLEAN" remarks="true if the message is already scheduled to be sent" />
            <column name="VERSION" type="INT" defaultValueNumeric="0" remarks="Used for optimistic locking mechanism" >
                <constraints nullable="false"/>
            </column>
            <column name="MESSAGE_STATUS_ID_FK" type="BIGINT"/>
            <column name="MSH_ROLE_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="NOTIFICATION_STATUS_ID_FK" type="BIGINT"/>

            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="MESSAGE_STATUS_ID_FK" baseTableName="TB_USER_MESSAGE_LOG"
                                 constraintName="FK_MSG_LOG_MSG_STATUS" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MESSAGE_STATUS"/>
        <addForeignKeyConstraint baseColumnNames="MSH_ROLE_ID_FK" baseTableName="TB_USER_MESSAGE_LOG"
                                 constraintName="FK_MSG_LOG_MSH_ROLE" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MSH_ROLE"/>
        <addForeignKeyConstraint baseColumnNames="NOTIFICATION_STATUS_ID_FK" baseTableName="TB_USER_MESSAGE_LOG"
                                 constraintName="FK_MSG_LOG_NOTIF_STATUS" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_NOTIFICATION_STATUS"/>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_USER_MESSAGE_LOG"
                                 constraintName="FK_MSG_LOG_MSG_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <createIndex indexName="IDX_MESSAGE_LOG_MSG_STATUS_ID" tableName="TB_USER_MESSAGE_LOG">
            <column name="MESSAGE_STATUS_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_MESSAGE_LOG_MSG_ROLE_ID" tableName="TB_USER_MESSAGE_LOG">
            <column name="MSH_ROLE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_MSG_LOG_NOTIF_STATUS_ID" tableName="TB_USER_MESSAGE_LOG">
            <column name="NOTIFICATION_STATUS_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_USER_LOG_RECEIVED" tableName="TB_USER_MESSAGE_LOG">
            <column name="RECEIVED"/>
        </createIndex>

        <!-- create TB_SIGNAL_MESSAGE_LOG -->
        <createTable tableName="TB_SIGNAL_MESSAGE_LOG">
            <column name="ID_PK" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_SIGNAL_MESSAGE_LOG"/>
            </column>
            <column name="RECEIVED" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="DELETED" type="TIMESTAMP"/>
            <column name="MESSAGE_STATUS_ID_FK" type="BIGINT"/>
            <column name="MSH_ROLE_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_SIGNAL_MESSAGE_LOG"
                                 constraintName="FK_SIGNAL_LOG_SIGNAL_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_SIGNAL_MESSAGE"/>
        <addForeignKeyConstraint baseColumnNames="MESSAGE_STATUS_ID_FK" baseTableName="TB_SIGNAL_MESSAGE_LOG"
                                 constraintName="FK_SIGNAL_LOG_MSG_STATUS" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MESSAGE_STATUS"/>
        <addForeignKeyConstraint baseColumnNames="MSH_ROLE_ID_FK" baseTableName="TB_SIGNAL_MESSAGE_LOG"
                                 constraintName="FK_SIGNAL_LOG_MSH_ROLE" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MSH_ROLE"/>
        <createIndex indexName="IDX_SIGNAL_LOG_MSG_STATUS_ID" tableName="TB_SIGNAL_MESSAGE_LOG">
            <column name="MESSAGE_STATUS_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_SIGNAL_LOG_MSG_ROLE_ID" tableName="TB_SIGNAL_MESSAGE_LOG">
            <column name="MSH_ROLE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_SIGNAL_LOG_RECEIVED" tableName="TB_SIGNAL_MESSAGE_LOG">
            <column name="RECEIVED"/>
        </createIndex>

        <!-- TODO add here the data migration script -->

        <!-- drop TB_MESSAGE_LOG -->
        <dropTable tableName="TB_MESSAGE_LOG"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-error-log-migration">
        <sql dbms="oracle">
            ALTER TABLE TB_ERROR_LOG RENAME CONSTRAINT PK_TB_ERROR_LOG TO PK_ERROR_LOG;
        </sql>
        <addColumn tableName="TB_ERROR_LOG">
            <column name="MSH_ROLE_ID_FK" type="BIGINT"/>
            <column name="USER_MESSAGE_ID_FK" type="BIGINT"/>
        </addColumn>

        <!-- TODO add migration script here -->

        <dropColumn tableName="TB_ERROR_LOG" columnName="MSH_ROLE" />

        <addForeignKeyConstraint baseColumnNames="MSH_ROLE_ID_FK" baseTableName="TB_ERROR_LOG"
                                 constraintName="FK_ERROR_LOG_MSH_ROLE" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MSH_ROLE"/>
        <addForeignKeyConstraint baseColumnNames="USER_MESSAGE_ID_FK" baseTableName="TB_ERROR_LOG"
                                 constraintName="FK_ERROR_LOG_MSG_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <createIndex indexName="IDX_ERROR_LOG_MSH_ROLE_ID" tableName="TB_ERROR_LOG">
            <column name="MSH_ROLE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_ERROR_LOG_MSG_ID" tableName="TB_ERROR_LOG">
            <column name="USER_MESSAGE_ID_FK"/>
        </createIndex>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-party-id-migration">

        <!-- TODO add here the data migration script into TB_D_PARTY-->

        <dropAllForeignKeyConstraints baseTableName="TB_PARTY_ID"/>
        <dropTable tableName="TB_PARTY_ID"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-property-migration">
        <!-- first we create TB_MESSAGE_PROPERTIES -->
        <createTable tableName="TB_MESSAGE_PROPERTIES">
            <column name="ID_PK" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="PK_MSG_PROPERTIES"/>
            </column>
            <column name="USER_MESSAGE_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="MESSAGE_PROPERTY_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="USER_MESSAGE_ID_FK" baseTableName="TB_MESSAGE_PROPERTIES"
                                 constraintName="FK_MSG_PROPS_USER_MSG" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_USER_MESSAGE"/>
        <addForeignKeyConstraint baseColumnNames="MESSAGE_PROPERTY_FK" baseTableName="TB_MESSAGE_PROPERTIES"
                                 constraintName="FK_MSG_PROPS_MSG_PROP" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_D_MESSAGE_PROPERTY"/>
        <createIndex indexName="IDX_MSG_PROPS_MSG_ID" tableName="TB_MESSAGE_PROPERTIES">
            <column name="USER_MESSAGE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_MSG_PROPS_MSG_PROP" tableName="TB_MESSAGE_PROPERTIES">
            <column name="MESSAGE_PROPERTY_FK"/>
        </createIndex>
        <addUniqueConstraint columnNames="USER_MESSAGE_ID_FK,MESSAGE_PROPERTY_FK" constraintName="UK_MSG_PROPS_FKS" tableName="TB_MESSAGE_PROPERTIES"/>

        <!-- TODO add here the data migration script into TB_MESSAGE_PROPERTIES and TB_D_MESSAGE_PROPERTY -->

        <!-- drop FKs and old table TB_PROPERTY-->
        <dropAllForeignKeyConstraints baseTableName="TB_PROPERTY"/>
        <dropTable tableName="TB_PROPERTY"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-rawenvelope-log-migration">
        <createTable tableName="TB_USER_MESSAGE_RAW">
            <column name="ID_PK" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_USER_MESSAGE_RAW"/>
            </column>
            <column name="RAW_XML" type="BLOB"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_USER_MESSAGE_RAW"
                                 constraintName="FK_MSG_RAW_USER_MSG" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_USER_MESSAGE"/>
        <createTable tableName="TB_SIGNAL_MESSAGE_RAW">
            <column name="ID_PK" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="PK_SIGNAL_MESSAGE_RAW"/>
            </column>
            <column name="RAW_XML" type="BLOB"/>
            <column defaultValueComputed="${now}" name="CREATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was created">
                <constraints nullable="false"/>
            </column>
            <column defaultValueComputed="${current_db_user}" name="CREATED_BY" type="VARCHAR(255)" remarks="The user who created this record">
                <constraints nullable="false"/>
            </column>
            <column name="MODIFICATION_TIME" type="TIMESTAMP" remarks="The date and time when this record was last modified"/>
            <column name="MODIFIED_BY" type="VARCHAR(255)" remarks="The user who last modified this record"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_SIGNAL_MESSAGE_RAW"
                                 constraintName="FK_SIGNAL_MSG_RAW_SIGNAL_MSG" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_SIGNAL_MESSAGE"/>

        <!-- TODO add here the data migration script into TB_USER_MESSAGE_RAW and TB_SIGNAL_MESSAGE_RAW -->

        <dropAllForeignKeyConstraints baseTableName="TB_RAWENVELOPE_LOG" />
        <dropTable tableName="TB_RAWENVELOPE_LOG"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-user-message">
        <sql dbms="oracle">
            ALTER TABLE TB_USER_MESSAGE RENAME CONSTRAINT PK_TB_USER_MESSAGE TO PK_USER_MESSAGE;
        </sql>
        <dropAllForeignKeyConstraints baseTableName="TB_USER_MESSAGE" />
        <dropIndex tableName="TB_USER_MESSAGE" indexName="FK_BE4XC1069QYW2KLHVM3XMG26S"/>
        <dropIndex tableName="TB_USER_MESSAGE" indexName="FK_UM_MF"/>


        <addColumn tableName="TB_USER_MESSAGE">
            <column name="MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="REF_TO_MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="CONVERSATION_ID" type="VARCHAR(255)"/>
            <column name="SOURCE_MESSAGE" remarks="true if the message is a SourceMessage" type="BOOLEAN"/>
            <column name="MESSAGE_FRAGMENT" remarks="true if the message is a message fragment" type="BOOLEAN"/>
            <column name="EBMS3_TIMESTAMP" type="TIMESTAMP" remarks="the EBMS3 timestamp present in eb:Messaging/eb:UserMessage/eb:MessageInfo/eb:Timestamp"/>
            <column name="ACTION_ID_FK" type="BIGINT"/>
            <column name="AGREEMENT_ID_FK" type="BIGINT"/>
            <column name="SERVICE_ID_FK" type="BIGINT"/>
            <column name="MPC_ID_FK" type="BIGINT"/>
            <column name="FROM_PARTY_ID_FK" type="BIGINT"/>
            <column name="FROM_ROLE_ID_FK" type="BIGINT"/>
            <column name="TO_PARTY_ID_FK" type="BIGINT"/>
            <column name="TO_ROLE_ID_FK" type="BIGINT"/>
            <column name="MESSAGE_SUBTYPE_ID_FK" type="BIGINT"/>
        </addColumn>

        <!-- TODO add here migration data script from old columns to new ones -->


        <dropColumn columnName="COLLABORATION_INFO_ACTION" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="AGREEMENT_REF_PMODE" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="AGREEMENT_REF_TYPE" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="AGREEMENT_REF_VALUE" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="COLL_INFO_CONVERS_ID" tableName="TB_USER_MESSAGE"/>

        <dropColumn columnName="SERVICE_TYPE" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="SERVICE_VALUE" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="MPC" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="FROM_ROLE" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="TO_ROLE" tableName="TB_USER_MESSAGE"/>

        <dropColumn columnName="MESSAGEINFO_ID_PK" tableName="TB_USER_MESSAGE"/>
        <dropColumn columnName="FK_MESSAGE_FRAGMENT_ID" tableName="TB_USER_MESSAGE"/>

        <!-- put back indexes and UQs -->
        <addForeignKeyConstraint baseColumnNames="ACTION_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_ACTION_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_ACTION"/>
        <addForeignKeyConstraint baseColumnNames="AGREEMENT_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_AGREEMENT_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_AGREEMENT"/>
        <addForeignKeyConstraint baseColumnNames="SERVICE_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_SERVICE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_SERVICE"/>
        <addForeignKeyConstraint baseColumnNames="MPC_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_MPC_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MPC"/>
        <addForeignKeyConstraint baseColumnNames="FROM_PARTY_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_FROM_PARTY_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_PARTY"/>
        <addForeignKeyConstraint baseColumnNames="FROM_ROLE_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_FROM_ROLE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_ROLE"/>
        <addForeignKeyConstraint baseColumnNames="TO_PARTY_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_TO_PARTY_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_PARTY"/>
        <addForeignKeyConstraint baseColumnNames="TO_ROLE_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_TO_ROLE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_ROLE"/>
        <addForeignKeyConstraint baseColumnNames="MESSAGE_SUBTYPE_ID_FK" baseTableName="TB_USER_MESSAGE"
                                 constraintName="FK_USER_MSG_SUBTYPE_ID" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_D_MESSAGE_SUBTYPE"/>
        <createIndex indexName="IDX_USER_MSG_MESSAGE_ID" tableName="TB_USER_MESSAGE">
            <column name="MESSAGE_ID"/>
        </createIndex>
        <createIndex indexName="IDX_USER_MSG_ACTION_ID" tableName="TB_USER_MESSAGE">
            <column name="ACTION_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_USER_MSG_AGREEMENT_ID" tableName="TB_USER_MESSAGE">
            <column name="AGREEMENT_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_USER_MSG_SERVICE_ID" tableName="TB_USER_MESSAGE">
            <column name="SERVICE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_USER_MSG_MPC_ID" tableName="TB_USER_MESSAGE">
            <column name="MPC_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_USER_MSG_FROM_PARTY_ID" tableName="TB_USER_MESSAGE">
            <column name="FROM_PARTY_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_FROM_ROLE_ID" tableName="TB_USER_MESSAGE">
            <column name="FROM_ROLE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_USER_MSG_TO_PARTY_ID" tableName="TB_USER_MESSAGE">
            <column name="TO_PARTY_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_TO_ROLE_ID" tableName="TB_USER_MESSAGE">
            <column name="TO_ROLE_ID_FK"/>
        </createIndex>
        <createIndex indexName="IDX_MESSAGE_SUBTYPE_ID" tableName="TB_USER_MESSAGE">
            <column name="MESSAGE_SUBTYPE_ID_FK"/>
        </createIndex>
        <addUniqueConstraint columnNames="MESSAGE_ID" constraintName="UK_USER_MSG_MESSAGE_ID" tableName="TB_USER_MESSAGE"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-send-attempt-migration">
        <sql dbms="oracle">
            ALTER TABLE TB_SEND_ATTEMPT RENAME CONSTRAINT PK_TB_SEND_ATTEMPT TO PK_SEND_ATTEMPT;
        </sql>
        <addColumn tableName="TB_SEND_ATTEMPT">
            <column name="USER_MESSAGE_ID_FK" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <dropIndex tableName="TB_SEND_ATTEMPT" indexName="IDX_SEND_ATTEMPT_MESSAGE_ID"/>
        <!-- TODO migration script MESSAGE_ID to USER_MESSAGE_ID_FK -->
        <dropColumn tableName="TB_SEND_ATTEMPT" columnName="MESSAGE_ID"/>
        <addForeignKeyConstraint baseColumnNames="USER_MESSAGE_ID_FK" baseTableName="TB_SEND_ATTEMPT"
                                 constraintName="FK_SEND_ATTEMPT_USER_MSG" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <createIndex indexName="IDX_MESSAGE_ID_FK" tableName="TB_SEND_ATTEMPT">
            <column name="USER_MESSAGE_ID_FK"/>
        </createIndex>
    </changeSet>
    <!-- End tables to be migrated -->

    <!-- Start modified tables (no data migration) -->
    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-part-info">
        <sql dbms="oracle">
            ALTER TABLE TB_PART_INFO RENAME CONSTRAINT PK_TB_PART_INFO TO PK_PART_INFO;
        </sql>
        <addColumn tableName="TB_PART_INFO">
            <column name="USER_MESSAGE_ID_FK" type="BIGINT"/>
        </addColumn>
        <addNotNullConstraint columnDataType="INT" columnName="PART_ORDER" tableName="TB_PART_INFO" />
        <addForeignKeyConstraint baseColumnNames="USER_MESSAGE_ID_FK" baseTableName="TB_PART_INFO"
                                 constraintName="FK_PART_INFO_USER_MSG" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <createIndex indexName="FK_USER_MESSAGE_ID" tableName="TB_PART_INFO">
            <column name="USER_MESSAGE_ID_FK"/>
        </createIndex>

        <dropForeignKeyConstraint baseTableName="TB_PART_INFO" constraintName="FK_TQ6LBN3MP0VSFC6QQU7WXY54G"/>
        <dropColumn columnName="PAYLOADINFO_ID" tableName="TB_PART_INFO"/>
        <dropColumn columnName="SCHEMA_LOCATION" tableName="TB_PART_INFO"/>
        <dropColumn columnName="SCHEMA_NAMESPACE" tableName="TB_PART_INFO"/>
        <dropColumn columnName="SCHEMA_VERSION" tableName="TB_PART_INFO"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-signal-message">
        <sql dbms="oracle">
            ALTER TABLE TB_SIGNAL_MESSAGE RENAME CONSTRAINT PK_TB_SIGNAL_MESSAGE TO PK_SIGNAL_MESSAGE;
        </sql>
        <dropColumn columnName="MESSAGEINFO_ID_PK" tableName="TB_SIGNAL_MESSAGE"/>
        <dropColumn columnName="PULL_REQUEST_MPC" tableName="TB_SIGNAL_MESSAGE"/>
        <dropForeignKeyConstraint baseTableName="TB_SIGNAL_MESSAGE"
                                  constraintName="FK_m6uu2y6g9buet3o3k1n4qxwec"/>
        <dropColumn columnName="RECEIPT_ID_PK" tableName="TB_SIGNAL_MESSAGE"/>

        <addColumn tableName="TB_SIGNAL_MESSAGE">
            <column name="SIGNAL_MESSAGE_ID" type="VARCHAR(255)"/>
            <column name="EBMS3_TIMESTAMP" type="TIMESTAMP" remarks="the EBMS3 timestamp present in eb:Messaging/eb:UserMessage/eb:MessageInfo/eb:Timestamp"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_SIGNAL_MESSAGE"
                                 constraintName="FK_TB_SIGNAL_USER_MSG" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_USER_MESSAGE"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-message-acknw">
        <sql dbms="oracle">
            ALTER TABLE TB_MESSAGE_ACKNW RENAME CONSTRAINT PK_TB_MESSAGE_ACKNW TO PK_MESSAGE_ACKNW;
        </sql>
        <dropIndex indexName="IDX_MSG_ACKNW_MESSAGE_ID" tableName="TB_MESSAGE_ACKNW"/>
        <dropColumn columnName="CREATE_DATE" tableName="TB_MESSAGE_ACKNW"/>
        <dropColumn columnName="CREATE_USER" tableName="TB_MESSAGE_ACKNW"/>
        <dropColumn columnName="MESSAGE_ID" tableName="TB_MESSAGE_ACKNW"/>

        <addColumn tableName="TB_MESSAGE_ACKNW">
            <column name="USER_MESSAGE_ID_FK" type="BIGINT"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="USER_MESSAGE_ID_FK" baseTableName="TB_MESSAGE_ACKNW"
                                 constraintName="FK_MSG_ACK_USER_MSG" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="ID_PK"
                                 referencedTableName="TB_USER_MESSAGE"/>
        <createIndex indexName="IDX_MSG_ACKNW_MESSAGE_ID_FK" tableName="TB_MESSAGE_ACKNW">
            <column name="USER_MESSAGE_ID_FK"/>
        </createIndex>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-receipt">
        <sql dbms="oracle">
            ALTER TABLE TB_RECEIPT RENAME CONSTRAINT PK_TB_RECEIPT TO PK_RECEIPT;
        </sql>
        <addColumn tableName="TB_RECEIPT">
            <column name="RAW_XML" type="BLOB"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="ID_PK" baseTableName="TB_RECEIPT"
                                 constraintName="FK_TB_RECEIPT_SIGNAL_MSG" deferrable="false"
                                 initiallyDeferred="false" onDelete="RESTRICT" onUpdate="RESTRICT"
                                 referencedColumnNames="ID_PK" referencedTableName="TB_SIGNAL_MESSAGE"/>
    </changeSet>

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-tb-command-property">
        <createIndex indexName="IDX_COMMAND_PROP_COMMAND_ID" tableName="TB_COMMAND_PROPERTY">
            <column name="FK_COMMAND"/>
        </createIndex>
    </changeSet>
    <!-- End modified tables -->

    <changeSet author="Catalin Enache" id="EDELIVERY-7833-oracle-sequence">
        <sql dbms="oracle">
            ALTER SEQUENCE HIBERNATE_SEQUENCE INCREMENT BY 20 CACHE 1000 NOORDER;
        </sql>
    </changeSet>

    <!-- End here 4.2 to new 5.0 -->
</databaseChangeLog>